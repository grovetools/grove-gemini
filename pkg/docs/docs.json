{
  "sections": {
    "command-reference": {
      "title": "Command Reference",
      "content": "This document provides a reference for the `gemapi` command-line interface, covering all subcommands and their options.",
      "subsections": [
        {
          "title": "`gemapi request`",
          "content": "Sends a request to the Gemini API. It can use `.grove/rules` to generate and attach file-based context.\n\n| Flag | Shorthand | Description |\n| --- | --- | --- |\n| `--model` | `-m` | The Gemini model to use for the request. |\n| `--prompt` | `-p` | The prompt text provided as an argument. |\n| `--file` | `-f` | The path to a file containing the prompt. |\n| `--output` | `-o` | The path to a file to write the response to (defaults to stdout). |\n| `--workdir` | `-w` | The working directory for the request (defaults to the current directory). |\n| `--context` | | A list of additional context files to include. |\n| `--regenerate` | | Forces the regeneration of context from `.grove/rules` before the request. |\n| `--recache` | | Forces the recreation of the Gemini cache, ignoring any existing valid cache. |\n| `--use-cache` | | Specifies a cache name (short hash) to use, bypassing automatic selection. |\n| `--no-cache` | | Disables the use of context caching for this request. |\n| `--cache-ttl` | | Sets a time-to-live duration for a new cache (e.g., `1h`, `30m`). |\n| `--yes` | `-y` | Skips the confirmation prompt for potentially costly cache creation. |\n| `--temperature` | | Sets the temperature for generation (0.0-2.0). |\n| `--top-p` | | Sets the top-p value for nucleus sampling (0.0-1.0). |\n| `--top-k` | | Sets the top-k value for sampling. |\n| `--max-output-tokens` | | Sets the maximum number of tokens to generate in the response. |\n\n**Examples**",
          "code_blocks": [
            "# Make a request with an inline prompt\ngemapi request -p \"Explain this Go function.\"\n\n# Use a prompt from a file and save the response to another file\ngemapi request -f prompt.md -o response.md\n\n# Force a rebuild of the cold context cache\ngemapi request --recache \"Analyze the latest version of the code.\""
          ]
        },
        {
          "title": "`gemapi cache`",
          "content": "Manages local records and remote state of Gemini API context caches.\n\n### `gemapi cache tui`\n\nLaunches an interactive terminal user interface (TUI) for browsing, inspecting, and managing caches.\n\n**Example**\n\n\n### `gemapi cache list`\n\nLists cached contexts, showing both local records and their status on Google's servers.\n\n| Flag | Description |\n| --- | --- |\n| `--local-only` | Shows only information from local cache files, without querying the API. |\n| `--api-only` | Shows only caches found on Google's API servers for the current project. |\n\n**Example**\n\n\n### `gemapi cache inspect`\n\nShows detailed information about a specific cache, including its creation date, expiration, token count, and the files it contains.\n\n**Example**\n\n\n### `gemapi cache clear`\n\nDeletes caches from Google's servers and updates local records. By default, it marks the local record as cleared but does not delete the file.\n\n| Flag | Description |\n| --- | --- |\n| `--all` | Clears all caches for the current project. |\n| `--with-local` | Also removes the local cache file, instead of just marking it as cleared. |\n| `--preserve-local` | Deletes the remote cache but does not modify the local cache file at all. |\n\n**Example**\n\n\n### `gemapi cache prune`\n\nIdentifies expired local cache records, deletes them from Google's servers, and marks them as cleared locally.\n\n| Flag | Description |\n| --- | --- |\n| `--remove-local` | Removes the local cache files for expired caches instead of marking them. |\n\n**Example**",
          "code_blocks": [
            "gemapi cache tui",
            "# List all caches with a combined local and remote view\ngemapi cache list\n\n# List only local cache records\ngemapi cache list --local-only",
            "gemapi cache inspect \u003ccache-name\u003e",
            "# Clear a specific cache from the remote API and update the local record\ngemapi cache clear \u003ccache-name\u003e\n\n# Clear all caches and delete the local files\ngemapi cache clear --all --with-local",
            "gemapi cache prune"
          ]
        },
        {
          "title": "`gemapi query`",
          "content": "Provides a suite of commands to inspect Gemini API usage and costs from various sources.\n\n### `gemapi query local`\n\nQueries the detailed request logs stored on the local machine.\n\n| Flag | Shorthand | Description |\n| --- | --- | --- |\n| `--hours` | `-H` | The number of hours to look back in the logs. |\n| `--limit` | `-l` | The maximum number of log entries to display. |\n| `--model` | `-m` | Filters the logs to a specific model name. |\n| `--errors` | | Shows only requests that resulted in an error. |\n\n**Example**\n\n\n### `gemapi query metrics`\n\nFetches aggregate metrics, such as request counts and error rates, from Google Cloud Monitoring.\n\n| Flag | Shorthand | Description |\n| --- | --- | --- |\n| `--project-id` | `-p` | The GCP project ID to query. |\n| `--hours` | `-H` | The number of hours to look back for metrics. |\n| `--debug` | | Enables debug output to help diagnose issues with metric filters. |\n\n**Example**\n\n\n### `gemapi query tokens`\n\nFetches detailed token usage logs from Google Cloud Logging. This provides data on prompt tokens, completion tokens, and cache hits.\n\n| Flag | Shorthand | Description |\n| --- | --- | --- |\n| `--project-id` | `-p` | The GCP project ID to query. |\n| `--hours` | `-H` | The number of hours to look back for logs. |\n| `--debug` | | Enables debug output for troubleshooting. |\n\n**Example**\n\n\n### `gemapi query billing`\n\nQueries cost data directly from a BigQuery billing export. This requires a BigQuery billing export to be configured for your GCP billing account.\n\n| Flag | Shorthand | Description |\n| --- | --- | --- |\n| `--project-id` | `-p` | The GCP project ID where BigQuery is located. |\n| `--dataset-id` | `-d` | The BigQuery dataset ID containing the billing table (required). |\n| `--table-id` | `-t` | The BigQuery table ID for the billing export (required). |\n| `--days` | | The number of days to look back in the billing data. |\n\n**Example**",
          "code_blocks": [
            "# View all requests from the last 12 hours\ngemapi query local --hours 12",
            "gemapi query metrics --project-id my-gcp-project --hours 48",
            "gemapi query tokens --project-id my-gcp-project",
            "gemapi query billing \\\n  --project-id my-gcp-project \\\n  --dataset-id my_billing_dataset \\\n  --table-id gcp_billing_export_v1_XXXX"
          ]
        },
        {
          "title": "`gemapi count-tokens`",
          "content": "Counts the number of tokens in a given text using the Gemini API tokenizer. Input can be provided as an argument or via stdin.\n\n| Flag | Shorthand | Description |\n| --- | --- | --- |\n| `--model` | `-m` | The model to use for token counting, as different models have different tokenization. |\n\n**Examples**",
          "code_blocks": [
            "# Count tokens from an argument\ngemapi count-tokens \"How many tokens is this string?\"\n\n# Count tokens from a file\ncat my_file.txt | gemapi count-tokens"
          ]
        },
        {
          "title": "`gemapi config`",
          "content": "Manages the local configuration for `gemapi`.\n\n### `gemapi config get project`\n\nDisplays the resolution order and the currently configured default GCP project ID.\n\n**Example**\n\n\n### `gemapi config set project`\n\nSets a default GCP project ID in the local configuration file.\n\n**Example**",
          "code_blocks": [
            "gemapi config get project",
            "gemapi config set project my-gcp-project-id"
          ]
        },
        {
          "title": "`gemapi version`",
          "content": "Prints version information for the `gemapi` binary.\n\n| Flag | Description |\n| --- | --- |\n| `--json` | Outputs the version information in JSON format. |\n\n**Example**",
          "code_blocks": [
            "gemapi version"
          ]
        }
      ]
    },
    "configuration": {
      "title": "Configuration",
      "content": "`gemapi` is configured through environment variables, a project-level `grove.yml` file, and user-specific settings.",
      "subsections": [
        {
          "title": "API Key Configuration",
          "content": "The Gemini API key is required for requests. `gemapi` resolves the key from the following sources in order of precedence:\n\n1.  **Environment Variable**: The `GEMINI_API_KEY` environment variable.\n    ```bash\n    export GEMINI_API_KEY=\"your-api-key-here\"\n    ```\n\n2.  **`api_key_command` in `grove.yml`**: A command in the project's `grove.yml` file that prints the API key to standard output when executed.\n    ```yaml\n    # grove.yml\n    gemini:\n      api_key_command: \"gcloud secrets versions access latest --secret=gemini-api-key\"\n    ```\n\n3.  **`api_key` in `grove.yml`**: The API key set directly in `grove.yml`.\n    ```yaml\n    # grove.yml\n    gemini:\n      api_key: \"your-api-key-here\"\n    ```\n\nIf an API key is not found in any of these sources, `gemapi` will return an error."
        },
        {
          "title": "GCP Project Configuration",
          "content": "Commands such as `gemapi query metrics` require a Google Cloud Project ID. A default project can be set to avoid passing the `--project-id` flag with each command.\n\n### Setting the Default Project\n\nThe `gemapi config set project` command saves a default project ID to a local configuration file.\n\n\n### Viewing the Default Project\n\nThe `gemapi config get project` command shows the current default project and the order in which it is resolved.\n\n\n**Example Output:**",
          "code_blocks": [
            "gemapi config set project your-gcp-project-id",
            "gemapi config get project",
            "GCP Project Resolution Order:\n1. Command flag: --project-id\n2. Environment variable GCP_PROJECT_ID: (not set)\n3. Saved configuration: your-gcp-project-id\n\nCurrent default project: your-gcp-project-id"
          ]
        },
        {
          "title": "Model Selection",
          "content": "The Gemini model is specified per-request using the `--model` (or `-m`) flag.\n\n\nIf the `--model` flag is not provided, the `request` command defaults to `gemini-2.0-flash`.",
          "code_blocks": [
            "gemapi request -m gemini-1.5-pro-latest \"Explain this code.\""
          ]
        },
        {
          "title": "Context Configuration",
          "content": "`gemapi` uses `grove-context` to include files from the codebase in API requests. This is enabled by creating a `.grove/rules` file in the project's root directory. No additional `gemapi` configuration is required.\n\nIf a `.grove/rules` file is present, `gemapi` will:\n1.  Generate a `.grove/context` file for \"hot\" context.\n2.  Generate a `.grove/cached-context` file for \"cold\" context.\n3.  Attach these context files to the `gemapi request`.\n\nThis behavior can be disabled for a specific request by running the command from a directory that does not contain a `.grove` subdirectory."
        },
        {
          "title": "Environment Variables",
          "content": "`gemapi` recognizes the following environment variables:\n\n| Variable | Description |\n| --- | --- |\n| `GEMINI_API_KEY` | Your Google Gemini API key. |\n| `GCP_PROJECT_ID` | Your default Google Cloud Project ID, used by `query` subcommands. |\n| `GROVE_DEBUG` | If set to `1` or `true`, enables logging that saves request payloads to local files. |"
        },
        {
          "title": "Configuration Files",
          "content": "`gemapi` uses two primary types of configuration files:\n\n-   **`grove.yml`**: The project-level configuration file in the repository root. It can contain `gemini`-specific settings for the API key.\n-   **`~/.grove/gemini-cache/gcp-config.json`**: A user-specific file that stores the default GCP Project ID set by `gemapi config set project`. This file should not be committed to version control."
        }
      ]
    },
    "examples": {
      "title": "Examples",
      "content": "This document provides examples for using `grove-gemini` for API calls and development workflows.",
      "subsections": [
        {
          "title": "Example 1: Basic API Requests",
          "content": "This example shows how to use the `gemapi request` command for direct interaction with the Gemini API.\n\n### Making a Simple Request\n\nA prompt can be provided as an argument. The tool sends the request to the default model and prints the response to standard output.\n\n\n### Using Files for Prompts and Outputs\n\nFiles can be used for longer prompts or to save output.\n\n1.  **Create a prompt file:**\n\n    ```bash\n    echo \"Write a simple 'Hello, World!' program in Go.\" \u003e prompt.md\n    ```\n\n2.  **Run the request:**\n    This command uses the `-f` flag to read the prompt from `prompt.md`, specifies a model with `-m`, and saves the generated code to `main.go` using the `-o` flag.\n\n    ```bash\n    gemapi request -f prompt.md -o main.go -m gemini-1.5-flash-latest\n    ```\n\n3.  **Verify the output:**\n    The `main.go` file will contain the Go code generated by the API.\n\n    ```bash\n    cat main.go\n    ```\n    ```go\n    package main\n\n    import \"fmt\"\n\n    func main() {\n        fmt.Println(\"Hello, World!\")\n    }\n    ```",
          "code_blocks": [
            "gemapi request \"What is the Go programming language?\""
          ]
        },
        {
          "title": "Example 2: Requests with Codebase Context",
          "content": "When a `.grove/rules` file is present, `gemapi` reads it to determine which project files to include in the request. This provides the model with the contents of the matched files.\n\n1.  **Set up the project:**\n    Create a Go project with two files.\n\n    `main.go`:\n    ```go\n    package main\n\n    import \"fmt\"\n\n    func main() {\n        message := GetGreeting()\n        fmt.Println(message)\n    }\n    ```\n\n    `greeting.go`:\n    ```go\n    package main\n\n    func GetGreeting() string {\n        return \"Hello from a separate file!\"\n    }\n    ```\n\n2.  **Define the context rules:**\n    Create a `.grove/rules` file to specify which files to include.\n\n    ```bash\n    mkdir -p .grove\n    echo \"*.go\" \u003e .grove/rules\n    ```\n\n3.  **Make a context-aware request:**\n    `gemapi` finds the `.grove/rules` file, gathers all `.go` files, and attaches them to the request.\n\n    ```bash\n    gemapi request \"Based on the provided code, what will be printed when I run the program?\"\n    ```\n\n    The model receives the content of both `main.go` and `greeting.go` and can determine the output.\n\n    **Expected Output:**\n    ```\n    Based on the provided code, when you run the program, it will print:\n\n    Hello from a separate file!\n    ```\n\n4.  **Regenerating Context:**\n    If the `.grove/rules` file changes, the `--regenerate` flag can be used to force `gemapi` to regenerate the context files before making a request.\n\n    ```bash\n    gemapi request --regenerate \"Summarize the project based on the new rules.\"\n    ```"
        },
        {
          "title": "Example 3: Caching and Observability (Experimental)",
          "content": "WARNING: EXPERIMENTAL\n\nFor requests involving large, unchanging sets of files, `gemapi` can use the Gemini Caching API to store the context. This is an opt-in, experimental feature.\n\n1.  **Enable Caching:**\n    Caching is enabled by adding the `@enable-cache` directive to a `.grove/rules` file. This instructs `gemapi` to treat files matched by the rules as \"cold context\" for caching.\n\n    `.grove/rules`:\n    ```\n    @enable-cache\n    *.go\n    ```\n\n2.  **Run the first request to create the cache:**\n    The first request with a new context will create a cache on Google's servers, which may increase latency for that initial call. The `--yes` flag can be used to skip the confirmation prompt.\n\n    ```bash\n    gemapi request --yes \"What is the purpose of the GetGreeting function?\"\n    ```\n\n3.  **Run a second request to use the cache:**\n    Subsequent requests will reuse the existing cache if it is still valid. The token usage summary will show a number of `Cold (Cached)` tokens.\n\n    ```bash\n    gemapi request \"How is the greeting message generated?\"\n    ```\n\n4.  **Observability Commands:**\n    `gemapi` provides commands to inspect API usage.\n\n    *   **Inspect Caches**: Launches a terminal interface for viewing cache records, their status, and usage statistics.\n\n        ```bash\n        gemapi cache tui\n        ```\n\n    *   **Query Local Logs**: The `query local` command reads logs stored on the local machine.\n\n        ```bash\n        gemapi query local --hours 1\n        ```\n        This command displays a table of requests made in the last hour.\n\n    *   **Query Billing Data**: The `query billing` command can read cost data from a BigQuery billing export, which requires a one-time setup in a GCP account.\n\n        ```bash\n        gemapi query billing \\\n          --project-id your-gcp-project \\\n          --dataset-id your_billing_dataset \\\n          --table-id your_billing_table\n        ```"
        }
      ]
    },
    "experimental": {
      "title": "Experimental",
      "content": "This section covers features that are under active development. Their behavior and interfaces are subject to change.",
      "subsections": [
        {
          "title": "Context Caching",
          "content": "The context caching feature uses the Gemini Caching API to store \"cold context\" files between requests.\n\n\u003e **⚠️ CRITICAL WARNING: Risk of Substantial Unexpected Charges**\n\u003e\n\u003e The Gemini Caching API is a billable service. Misuse or misconfiguration of this feature can lead to substantial and unexpected charges on your Google Cloud account.\n\u003e\n\u003e The primary risk comes from frequent cache invalidation. If your \"cold context\" files change often or your cache TTL is too short, `gemapi` will repeatedly create new caches, incurring costs for both the cache creation API calls and the storage of the cached content.\n\u003e\n\u003e **This feature is NOT recommended for general use until it is further stabilized.** Use it only if you fully understand the cost implications and are actively monitoring your billing.\n\nThe caching functionality is enabled by adding an `@enable-cache` directive to your `.grove/rules` file. The behavior can be controlled with command-line flags (`--no-cache`, `--recache`, `--use-cache`, `--cache-ttl`) and other directives (`@freeze-cache`, `@no-expire`). These controls are also considered experimental."
        },
        {
          "title": "Observability Integration",
          "content": "Integration with other tools for observability, such as emitting events to `grove-hooks` for session tracking and performance monitoring, is currently under development. The event schemas and integration points are subject to change in future releases."
        }
      ]
    },
    "overview": {
      "title": "Overview",
      "content": "\u003cimg src=\"./images/grove-gemini-readme.svg\" width=\"60%\" /\u003e\n\nGrove Gemini (`gemapi`) is a command-line interface for Google's Gemini API that supports development workflows by managing codebase context and API interactions. The tool can use the Gemini Caching API for large contexts and includes commands to query local logs and Google Cloud for usage metrics and billing data.\n\n\u003c!-- placeholder for animated gif --\u003e",
      "subsections": [
        {
          "title": "Key Features",
          "content": "*   **Context Management**: Builds prompt context by reading a `.grove/rules` file and passing matching files to the API. This process is handled by `grove-context`.\n\n*   **Caching (experimental)**: Caches \"cold context\" files using the Gemini Caching API via an `@enable-cache` directive. Provides a terminal interface (`gemapi cache tui`) for cache management.\n\n*   **Observability (experimental)**: Includes a `query` command to inspect API usage from multiple sources: `query local` for local logs, `query metrics` for Google Cloud Monitoring, `query tokens` for Google Cloud Logging, and `query billing` for BigQuery exports.\n\n*   **Token Utilities**: Provides a `count-tokens` command to estimate token count and cost for a given text before making an API call."
        },
        {
          "title": "How It Works",
          "content": "When `gemapi request` is executed, it first checks for a `.grove/rules` file in the current project. If found, it uses `grove-context` to generate context files based on the defined patterns.\n\nIf caching is enabled via an `@enable-cache` directive, the tool attempts to find a valid cache for static \"cold context\" files. If none is found or if files have changed, it creates a new cache via the Gemini Caching API.\n\nThe final request to the Gemini API includes the user's prompt, any \"hot context\" files, and a reference to the cached content. The tool logs request metrics locally and prints the API response to standard output."
        },
        {
          "title": "Ecosystem Integration",
          "content": "Grove Gemini functions as a component of the Grove tool suite and executes other tools in the ecosystem as subprocesses.\n\n*   **Grove Meta-CLI (`grove`)**: Handles installation, updates, and version management of `grove-gemini` and other tools.\n\n*   **Grove Context (`cx`)**: Before executing a request, `gemapi` calls `grove-context` to read `.grove/rules` files and generate file-based context, which is then provided to the Gemini API."
        },
        {
          "title": "Installation",
          "content": "Install via the Grove meta-CLI:\n\nVerify installation:\n\nRequires the `grove` meta-CLI. See the [Grove Installation Guide](https://github.com/mattsolo1/grove-meta/blob/main/docs/02-installation.md) if you don't have it installed.",
          "code_blocks": [
            "grove install gemini",
            "gemapi version"
          ]
        }
      ]
    }
  }
}